<!doctype html>
<meta charset="utf-8" />
<title>LIFF Check-in</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<body>
<h3>Check-in</h3>
<button id="checkin">寫入今天時間</button>
<pre id="log"></pre>

<script>
    const LIFF_ID = "2008152857-OWRgNdDE";              // ← 換成你的 LIFF ID
    const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbzKfPB1TrAxjH0fs9FX-VcgnWBkfv5iceuWZH_bAURpzVx6qkhjf3q122_BheSrR1Ls/exec?token=test1106";    // ← 部署好的 Apps Script /exec

    const TOKEN = "test1106";

const log = (...a) => (document.getElementById('log').textContent += a.join(' ') + '\n');

(async function init() {
  await liff.init({ liffId: LIFF_ID });
  if (!liff.isLoggedIn()) {
    liff.login({ scope: ['openid','profile'], redirectUri: location.href });
    return;
  }
  log('LIFF ready');
})();

async function getUserId() {
  try {
    const p = await liff.getProfile();         // 需要 profile scope
    if (p && p.userId) return p.userId;
  } catch {}
  const decoded = liff.getDecodedIDToken();    // 需要 openid scope
  if (decoded && decoded.sub) return decoded.sub;
  return null;
}

async function checkIn() {
  const userId = await getUserId();
  if (!userId) {
    log('無法取得 userId，請確認 LIFF scope: openid, profile');
    return;
  }
  // 用 <img> beacon 送 GET（避免 CORS；不會跳頁）
  const url = `${GAS_EXEC}?token=${encodeURIComponent(TOKEN)}&user=${encodeURIComponent(userId)}&_=${Date.now()}`;
  const img = new Image();
  img.onload = img.onerror = () => log('已送出（不讀回應）');
  img.src = url;

  // 也可以改用 fetch + no-cors（同樣不讀回應）
  // fetch(url, { method: 'GET', mode: 'no-cors', cache: 'no-cache' });
}

document.getElementById('checkin').addEventListener('click', checkIn);
</script>
</body>
